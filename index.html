<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fukuoka Trip 2025 (Optimized)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'snow-white': '#F0FFFF', 'ice-blue': '#B3E5FC', 'deep-sea-blue': '#01579B',
                'accent-yellow': '#FFD54F', 'soft-gray': '#F5F5F5', 'warm-beige': '#FFF8E7'
            }
        }
    }
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
body { background-color: #FFF8E7; font-family: 'Noto Sans TC', sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; }
.app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0,0,0,0.1); position: relative; padding-bottom: 100px; }
.hide-scrollbar::-webkit-scrollbar { display: none; }
.card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
.animate-fade-in { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.category-pill.active { background-color: #01579B; color: white; box-shadow: 0 2px 8px rgba(1, 87, 155, 0.3); }
.category-pill { border: 1px solid #e2e8f0; color: #64748b; background: white; padding: 6px 14px; border-radius: 99px; font-size: 12px; font-weight: bold; transition: all 0.2s; white-space: nowrap; }
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }
</style>
</head>
<body>

<div id="app" class="app-container">

    <div class="relative bg-white rounded-b-[35px] shadow-lg overflow-hidden z-10">
        <div class="h-[280px] relative bg-warm-beige">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/60 z-10"></div>
            <img src="https://images.unsplash.com/photo-1629636608529-6886e7a2b02e?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover absolute top-0 left-0" alt="Fukuoka">
            
            <div class="absolute bottom-4 left-5 z-20 text-white w-[90%]">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold shadow-black drop-shadow-md">{{ tripSettings.title }}</h1>
                    <button @click="showTitleModal = true" class="ml-2 bg-white/20 backdrop-blur-md p-1.5 rounded-full hover:bg-white/40 transition-colors">
                        <i class="fa-solid fa-pencil text-xs text-white"></i>
                    </button>
                </div>
                <p class="text-sm font-medium mt-1 opacity-90 text-white shadow-black drop-shadow-sm">{{ tripSettings.subtitle }}</p>
            </div>
            
            <button @click="currentTab = 'info'" class="absolute top-4 right-4 z-30 bg-black/30 backdrop-blur-md text-white w-9 h-9 rounded-full flex items-center justify-center border border-white/20">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </div>

    <main class="p-4 relative z-5">
        
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-sm pt-2 pb-2 -mx-4 px-4 border-b border-slate-100 flex items-center overflow-x-auto hide-scrollbar space-x-2 snap-x">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                    class="snap-center flex-shrink-0 w-[56px] h-[64px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border border-slate-100"
                    :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white shadow-md transform scale-105 border-deep-sea-blue' : 'bg-white text-slate-400 hover:bg-slate-50'">
                    <span class="text-xs font-bold">{{ day.weekday }}</span>
                    <span class="text-sm font-bold">{{ day.date }}</span>
                </div>
                <div class="flex flex-col space-y-1 ml-1 border-l border-slate-200 pl-2">
                    <button @click="addNewDay" class="w-7 h-7 rounded-full bg-slate-100 text-deep-sea-blue flex items-center justify-center"><i class="fa-solid fa-plus text-[10px]"></i></button>
                    <button v-if="dates.length > 1" @click="removeLastDay" class="w-7 h-7 rounded-full bg-slate-100 text-red-400 flex items-center justify-center"><i class="fa-solid fa-minus text-[10px]"></i></button>
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" @click="openWeatherModal" class="mt-4 mb-4 bg-gradient-to-r from-blue-50 to-white border border-blue-100 rounded-2xl p-4 flex justify-between items-center shadow-sm cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center text-deep-sea-blue space-x-3">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-4xl text-blue-500"></i>
                    <div>
                        <div class="flex items-baseline">
                            <span class="text-2xl font-bold">{{ weatherData[selectedDateIndex].temp }}</span>
                            <span class="text-xs text-slate-500 ml-1">°C</span>
                        </div>
                        <span class="text-xs text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded">降雨 {{ weatherData[selectedDateIndex].chance }}%</span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-sm font-bold text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    <span class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-pen mr-1"></i>點擊修改</span>
                </div>
            </div>

            <div class="space-y-5 pb-20">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                        <div class="h-8 w-0.5 bg-slate-200 absolute left-6 -top-4"></div>
                        <i :class="getTransportIcon(currentItinerary[idx].transportType)" class="mr-2 text-slate-300"></i>
                        <span class="bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100">{{ item.travelTime || '移動' }}</span>
                    </div>

                    <div class="bg-white rounded-2xl p-4 card-shadow border border-slate-50 flex items-start">
                        <div class="mr-3 flex flex-col items-center flex-shrink-0 w-[70px]">
                            <div v-if="item.image" class="w-16 h-16 rounded-xl overflow-hidden mb-1 bg-slate-100">
                                <img :src="item.image" class="w-full h-full object-cover">
                            </div>
                            <div v-else class="w-16 h-16 rounded-xl flex items-center justify-center text-2xl mb-1 text-white shadow-sm" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="text-base font-bold text-slate-800 leading-snug">{{ item.name }}</h3>
                                <div class="flex space-x-1 ml-2">
                                    <button @click.stop="openMap(item.name, item.address)" class="w-7 h-7 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center text-xs hover:bg-blue-600 hover:text-white transition-colors">
                                        <i class="fa-solid fa-location-arrow"></i>
                                    </button>
                                    <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center text-xs hover:bg-slate-200">
                                        <i class="fa-solid fa-pencil"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="text-xs text-slate-500 space-y-1 mt-2">
                                <p v-if="item.address" class="flex items-center truncate">
                                    <i class="fa-solid fa-location-dot w-4 text-center mr-1 text-slate-300"></i> 
                                    <span class="truncate">{{ item.address }}</span>
                                    <button @click.stop="copyText(item.address)" class="ml-2 text-blue-400 hover:text-blue-600"><i class="fa-regular fa-copy"></i></button>
                                </p>
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-1 text-slate-300"></i> {{ item.hours }}</p>
                            </div>

                            <div v-if="item.note" class="mt-2 text-xs bg-slate-50 p-2 rounded-lg text-slate-600 border border-slate-100">
                                <div class="whitespace-pre-line" :class="item.isNoteExpanded ? '' : 'line-clamp-2'" v-html="formatNoteWithLinks(item.note)"></div>
                                <button v-if="item.note.length > 30" @click.stop="item.isNoteExpanded = !item.isNoteExpanded" class="text-blue-500 font-bold mt-1 block w-full text-center hover:bg-blue-50 rounded py-1">
                                    <i class="fa-solid" :class="item.isNoteExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute -right-3 top-1/2 -translate-y-1/2 flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button v-if="idx > 0" @click.stop="moveItineraryUp(item.id)" class="w-6 h-6 bg-white shadow text-slate-400 rounded-full text-[10px]"><i class="fa-solid fa-arrow-up"></i></button>
                         <button v-if="idx < currentItinerary.length - 1" @click.stop="moveItineraryDown(item.id)" class="w-6 h-6 bg-white shadow text-slate-400 rounded-full text-[10px]"><i class="fa-solid fa-arrow-down"></i></button>
                    </div>
                </div>

                <div v-if="currentItinerary.length === 0" class="text-center py-20 text-slate-300">
                    <i class="fa-solid fa-map-location-dot text-5xl mb-4 opacity-50"></i>
                    <p>本日尚無行程<br>點擊下方 + 新增</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-6 animate-fade-in pb-20">
            <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg">
                <h3 class="font-bold mb-3"><i class="fa-solid fa-cloud-arrow-up mr-2 text-accent-yellow"></i>資料備份與還原</h3>
                <p class="text-xs text-slate-400 mb-4">建議出發前備份一次，以防資料遺失。</p>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="backupData" class="bg-blue-600 hover:bg-blue-500 py-2.5 rounded-xl font-bold text-sm shadow transition-colors">
                        <i class="fa-solid fa-download mr-1"></i> 下載備份
                    </button>
                    <div class="relative">
                        <input type="file" id="restoreFile" @change="restoreData" class="hidden" accept=".json">
                        <label for="restoreFile" class="block w-full text-center bg-slate-600 hover:bg-slate-500 py-2.5 rounded-xl font-bold text-sm cursor-pointer transition-colors">
                            <i class="fa-solid fa-upload mr-1"></i> 還原備份
                        </label>
                    </div>
                </div>
                <button @click="resetData" class="w-full mt-3 text-xs text-red-400 hover:text-red-300 py-2 underline">重置所有資料 (清空)</button>
            </div>

            <div class="bg-gradient-to-r from-deep-sea-blue to-blue-700 rounded-2xl p-5 text-white shadow-md relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold mb-4 flex justify-between">
                        <span><i class="fa-solid fa-calculator mr-2"></i>匯率換算</span>
                        <div class="flex items-center text-xs bg-white/20 rounded-full px-2 py-1">
                            <span class="mr-1">匯率</span>
                            <input type="number" v-model="exchangeRate" @input="calculateCurrency" step="0.001" class="w-12 bg-transparent text-center font-bold outline-none border-b border-white/50 focus:border-white">
                        </div>
                    </h3>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 bg-white/10 rounded-xl p-2">
                            <label class="text-[10px] text-blue-200 block">JPY</label>
                            <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-transparent text-xl font-bold outline-none placeholder-blue-300/50" placeholder="0">
                        </div>
                        <i class="fa-solid fa-right-left text-blue-300"></i>
                        <div class="flex-1 bg-white/10 rounded-xl p-2 border border-white/20">
                            <label class="text-[10px] text-blue-200 block">TWD</label>
                            <div class="text-xl font-bold">{{ currencyResult }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800">航班與住宿</h3>
                    <div class="flex space-x-2">
                        <button @click="openInfoModal('flight')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-bold">+ 航班</button>
                        <button @click="openInfoModal('hotel')" class="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded-full font-bold">+ 住宿</button>
                    </div>
                </div>
                <div v-for="(f, i) in flightList" :key="'f'+i" class="mb-3 bg-slate-50 p-3 rounded-xl border border-slate-100 relative group">
                    <button @click="removeFlight(i)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-deep-sea-blue">{{ f.origin }} <i class="fa-solid fa-plane mx-1 text-xs text-slate-400"></i> {{ f.dest }}</span>
                        <span class="text-xs font-mono bg-white px-1.5 rounded text-slate-500 border">{{ f.code }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-slate-600">
                        <span>{{ f.depTime }}</span>
                        <span>{{ f.arrTime }}</span>
                    </div>
                </div>
                <div v-for="(h, i) in hotelList" :key="'h'+i" class="mb-3 bg-purple-50/50 p-3 rounded-xl border border-purple-100 relative">
                    <button @click="removeHotel(i)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    <h4 class="font-bold text-slate-800 text-sm">{{ h.name }}</h4>
                    <p class="text-xs text-slate-500 mt-1 flex items-center justify-between">
                        <span>{{ h.date }}</span>
                        <button v-if="h.address" @click="openMap(h.name, h.address)" class="text-purple-500"><i class="fa-solid fa-location-dot"></i> 導航</button>
                    </p>
                    <p v-if="h.address" class="text-[10px] text-slate-400 mt-1 truncate">{{ h.address }}</p>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-3"><i class="fa-solid fa-pen-to-square text-accent-yellow mr-2"></i>備忘錄</h3>
                <textarea v-model="memoText" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-1 focus:ring-deep-sea-blue min-h-[100px]" placeholder="輸入文字或網址..."></textarea>
                <div v-if="parsedLinks.length > 0" class="flex flex-wrap gap-2 mt-2">
                    <a v-for="(link, idx) in parsedLinks" :key="idx" :href="link" target="_blank" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center hover:bg-blue-100 truncate max-w-full">
                        <i class="fa-solid fa-link mr-1.5"></i> 連結 {{ idx + 1 }}
                    </a>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'food' || currentTab === 'shopping'" class="animate-fade-in pb-20">
            <div class="sticky top-0 bg-[#FFF8E7] z-10 pb-2 pt-1 -mx-4 px-4">
                <div class="relative mb-2">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input v-model="searchQuery" type="text" :placeholder="currentTab === 'food' ? '搜尋美食...' : '搜尋購物...'" class="w-full bg-white rounded-xl py-3 pl-10 pr-10 shadow-sm text-sm outline-none border border-slate-100">
                    <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-3 top-3 text-slate-300"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-1">
                    <button v-for="cat in currentCategories" :key="cat" @click="selectedCategory = cat" :class="['category-pill', selectedCategory === cat ? 'active' : '']">{{ cat }}</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-2">
                <div v-for="item in filteredList" :key="item.originalIndex" class="bg-white rounded-xl p-2.5 card-shadow relative group" @click="openMap(item.name, item.address)">
                    <div class="aspect-square bg-slate-100 rounded-lg mb-2 overflow-hidden relative">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300 text-3xl">
                            <i :class="currentTab === 'food' ? 'fa-solid fa-utensils' : 'fa-solid fa-bag-shopping'"></i>
                        </div>
                        <div v-if="item.type" class="absolute top-1 left-1 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-0.5 rounded-full">{{ item.type }}</div>
                        
                        <div class="absolute top-1 right-1 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click.stop="editListItem(item)" class="w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center text-[10px]"><i class="fa-solid fa-pencil"></i></button>
                            <button @click.stop="removeListItem(item.originalIndex)" class="w-6 h-6 bg-red-500/80 text-white rounded-full flex items-center justify-center text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <h4 class="font-bold text-sm text-slate-800 truncate mb-0.5">{{ item.name }}</h4>
                    <p v-if="item.address" class="text-[10px] text-slate-400 truncate"><i class="fa-solid fa-location-dot mr-1"></i>{{ item.address }}</p>
                    <p class="text-[10px] text-slate-500 mt-1 line-clamp-2 leading-relaxed bg-slate-50 p-1 rounded min-h-[2em]">{{ item.note }}</p>
                </div>
            </div>
            
            <div v-if="filteredList.length === 0" class="text-center py-16 text-slate-400">
                <p>找不到項目</p>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20">
            <div class="bg-deep-sea-blue text-white rounded-2xl p-6 mb-4 shadow-lg relative overflow-hidden">
                <div class="absolute -right-5 -top-5 bg-white/10 w-32 h-32 rounded-full blur-2xl"></div>
                <p class="text-xs text-blue-200 mb-1">總支出預估</p>
                <h2 class="text-4xl font-bold mb-1">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm opacity-80 text-right border-t border-white/20 pt-2 mt-2">≈ NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>
            
            <div class="bg-white rounded-2xl p-4 card-shadow min-h-[300px]">
                <h3 class="font-bold text-slate-800 mb-4 px-1">支出明細</h3>
                <div v-if="expenses.length === 0" class="text-center py-10 text-slate-300 text-sm">尚未新增任何支出</div>
                <div v-else class="space-y-4">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center border-b border-slate-50 pb-3 last:border-0">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm mr-3 flex-shrink-0" :class="getCategoryColor(exp.category)">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400">{{ exp.date }} · {{ exp.payment === 'card' ? '信用卡' : '現金' }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-800">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400 text-xs mt-1 block w-full text-right">刪除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-2 py-1 flex justify-around items-center z-40 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.02)] max-w-[480px] mx-auto">
        <button v-for="tab in ['itinerary', 'food', 'shopping', 'expenses', 'info']" :key="tab" 
            @click="currentTab = tab" 
            class="flex flex-col items-center justify-center w-14 h-14 transition-all" 
            :class="currentTab === tab ? 'text-deep-sea-blue' : 'text-slate-300'">
            <i class="text-xl mb-1 transition-transform duration-200" 
               :class="[getTabIcon(tab), currentTab === tab ? '-translate-y-1' : '']"></i>
            <span class="text-[10px] font-bold">{{ getTabLabel(tab) }}</span>
        </button>
    </div>

    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-[80px] right-5 w-14 h-14 bg-accent-yellow rounded-full shadow-lg shadow-yellow-500/30 text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-105 transition-transform z-50 border-2 border-white">
        <i class="fa-solid fa-plus"></i>
    </button>
    
    <button v-show="showScrollTop" @click="scrollToTop" class="fixed bottom-[150px] right-6 w-10 h-10 bg-white/80 backdrop-blur text-slate-500 rounded-full shadow border border-slate-100 flex items-center justify-center z-40">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <div v-if="showModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="closeModal">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
            <h3 class="font-bold text-lg mb-4 text-center">{{ modalTitle }}</h3>
            
            <div class="space-y-3">
                <template v-if="modalType === 'itinerary'">
                    <input v-model="form.name" placeholder="名稱" class="input-field">
                    <select v-model="form.category" class="input-field">
                        <option value="sightseeing">景點</option><option value="food">飲食</option><option value="shopping">購物</option><option value="transport">交通</option><option value="other">其他</option>
                    </select>
                    <div class="flex gap-2">
                        <input v-model="form.startTime" type="time" class="input-field">
                        <input v-model="form.travelTime" placeholder="移動時間" class="input-field">
                    </div>
                    <input v-model="form.address" placeholder="地址" class="input-field">
                    <textarea v-model="form.note" placeholder="備註" class="input-field h-20"></textarea>
                </template>

                <template v-if="modalType === 'list'">
                    <input v-model="form.name" placeholder="名稱" class="input-field">
                    <select v-model="form.type" class="input-field">
                        <option v-for="c in (currentTab==='food'?foodCategories:shoppingCategories)" :value="c">{{c}}</option>
                    </select>
                    <input v-model="form.address" v-if="currentTab==='food'" placeholder="地址" class="input-field">
                    <input v-model="form.image" placeholder="圖片網址" class="input-field">
                    <textarea v-model="form.note" placeholder="備註" class="input-field h-20"></textarea>
                </template>
                
                <template v-if="modalType === 'expense'">
                    <input v-model="form.name" placeholder="項目名稱" class="input-field">
                    <input v-model.number="form.amount" type="number" placeholder="金額 (JPY)" class="input-field text-lg font-bold">
                    <div class="flex gap-2">
                        <button @click="form.payment='cash'" :class="form.payment==='cash'?'bg-blue-600 text-white':'bg-slate-100'" class="flex-1 py-2 rounded-lg text-sm">現金</button>
                        <button @click="form.payment='card'" :class="form.payment==='card'?'bg-blue-600 text-white':'bg-slate-100'" class="flex-1 py-2 rounded-lg text-sm">信用卡</button>
                    </div>
                </template>

                <template v-if="modalType === 'weather'">
                    <p class="text-sm text-center mb-2">{{ dates[selectedDateIndex]?.date }} 的天氣</p>
                    <select v-model="weatherForm.condition" class="input-field">
                        <option value="sunny">晴天</option><option value="cloudy">多雲</option><option value="rain">下雨</option><option value="snow">下雪</option>
                    </select>
                    <div class="flex items-center gap-2">
                         <input v-model="weatherForm.tempHigh" type="number" placeholder="最高溫" class="input-field">
                         <span>/</span>
                         <input v-model="weatherForm.tempLow" type="number" placeholder="最低溫" class="input-field">
                    </div>
                    <input v-model="weatherForm.chance" type="number" placeholder="降雨機率 %" class="input-field">
                </template>
                
                <template v-if="modalType === 'title'">
                     <input v-model="tripSettings.title" class="input-field" placeholder="標題">
                     <input v-model="tripSettings.subtitle" class="input-field" placeholder="副標題">
                </template>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="saveForm" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue

createApp({
    setup() {
        // --- 核心資料 ---
        const STORAGE_KEY = 'fukuoka_trip_optimized_v1';
        const currentTab = ref('itinerary');
        const showScrollTop = ref(false);
        const searchQuery = ref('');
        const selectedCategory = ref('全部');
        const tripSettings = ref({ title: 'Fukuoka Trip', subtitle: '2025 福岡之旅' });
        
        // 預設資料 (精簡版)
        const dates = ref([
            { date: '12/13', weekday: '六' }, { date: '12/14', weekday: '日' }, 
            { date: '12/15', weekday: '一' }, { date: '12/16', weekday: '二' }, { date: '12/17', weekday: '三' }
        ]);
        const itineraryData = ref([[],[],[],[],[]]); // 5天
        const weatherData = ref([
            { condition: 'sunny', temp: '12/6', chance: 10 }, { condition: 'cloudy', temp: '11/5', chance: 20 },
            { condition: 'rain', temp: '10/4', chance: 60 }, { condition: 'sunny', temp: '12/5', chance: 0 },
            { condition: 'cloudy', temp: '13/6', chance: 10 }
        ]);
        const foodList = ref([]);
        const shoppingList = ref([]);
        const expenses = ref([]);
        const flightList = ref([]);
        const hotelList = ref([]);
        const exchangeRate = ref(0.205);
        const currencyInput = ref(1000);
        const memoText = ref('');

        // Modal 相關
        const showModal = ref(false);
        const modalType = ref(''); // itinerary, list, expense, weather, title
        const form = ref({});
        const weatherForm = ref({});
        const isEdit = ref(false);
        const editIndex = ref(-1);

        // --- Computed ---
        const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
        const selectedDateIndex = ref(0);
        
        const foodCategories = ['全部', '拉麵', '麵包', '咖啡廳', '甜點', '居酒屋', '其他'];
        const shoppingCategories = ['全部', '伴手禮', '甜點', '藥妝', '服飾', '其他'];
        
        const currentCategories = computed(() => currentTab.value === 'food' ? foodCategories : shoppingCategories);
        
        const filteredList = computed(() => {
            const list = currentTab.value === 'food' ? foodList.value : shoppingList.value;
            return list.map((item, i) => ({...item, originalIndex: i})).filter(item => {
                const matchSearch = !searchQuery.value || item.name.includes(searchQuery.value) || (item.note && item.note.includes(searchQuery.value));
                const matchCat = selectedCategory.value === '全部' || item.type === selectedCategory.value;
                return matchSearch && matchCat;
            });
        });

        const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + (Number(e.amount)||0), 0));
        const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * exchangeRate.value));
        const currencyResult = computed(() => Math.round((currencyInput.value || 0) * exchangeRate.value));
        const parsedLinks = computed(() => (memoText.value.match(/(https?:\/\/[^\s]+)/g) || []));

        // --- Icon Helpers ---
        const getTabIcon = (t) => ({itinerary:'fa-solid fa-map-location-dot', food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', expenses:'fa-solid fa-coins', info:'fa-solid fa-user-gear'}[t]);
        const getTabLabel = (t) => ({itinerary:'行程', food:'美食', shopping:'購物', expenses:'花費', info:'設定'}[t]);
        const getCategoryIcon = (c) => ({sightseeing:'fa-solid fa-camera', food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', transport:'fa-solid fa-train', flight:'fa-solid fa-plane'}[c] || 'fa-solid fa-star');
        const getCategoryColor = (c) => ({sightseeing:'bg-green-500', food:'bg-red-500', shopping:'bg-indigo-500', transport:'bg-blue-500'}[c] || 'bg-slate-400');
        const getWeatherIcon = (c) => ({sunny:'fa-solid fa-sun', rain:'fa-solid fa-cloud-showers-heavy', cloudy:'fa-solid fa-cloud', snow:'fa-solid fa-snowflake'}[c]);
        const getTransportIcon = (t) => ({walk:'fa-solid fa-person-walking', public:'fa-solid fa-train-subway', bus:'fa-solid fa-bus', car:'fa-solid fa-car', flight:'fa-solid fa-plane'}[t] || 'fa-solid fa-arrow-right');
        const getWeatherDescription = (c) => ({sunny:'晴朗', rain:'有雨', cloudy:'多雲', snow:'下雪'}[c]);

        // --- Actions ---
        const handleAddClick = () => {
            isEdit.value = false;
            if(currentTab.value === 'itinerary') {
                modalType.value = 'itinerary';
                form.value = { name:'', category:'sightseeing', startTime:'', address:'', note:'', transportType:'public' };
            } else if (currentTab.value === 'food' || currentTab.value === 'shopping') {
                modalType.value = 'list';
                form.value = { name:'', type: currentTab.value==='food'?'拉麵':'伴手禮', address:'', note:'', image:'' };
            } else if (currentTab.value === 'expenses') {
                modalType.value = 'expense';
                form.value = { name:'', amount:'', category:'food', date: dates.value[selectedDateIndex.value]?.date || '', payment:'cash' };
            }
            showModal.value = true;
        };

        const editItem = (item) => {
            isEdit.value = true;
            modalType.value = 'itinerary';
            form.value = JSON.parse(JSON.stringify(item));
            showModal.value = true;
        };

        const editListItem = (item) => {
            isEdit.value = true;
            editIndex.value = item.originalIndex;
            modalType.value = 'list';
            form.value = JSON.parse(JSON.stringify(item));
            showModal.value = true;
        };

        const openWeatherModal = () => {
            modalType.value = 'weather';
            const w = weatherData.value[selectedDateIndex.value];
            const [high, low] = w.temp.split('/');
            weatherForm.value = { condition: w.condition, chance: w.chance, tempHigh: high, tempLow: low };
            showModal.value = true;
        };

        const saveForm = () => {
            if(modalType.value === 'weather') {
                weatherData.value[selectedDateIndex.value] = {
                    condition: weatherForm.value.condition,
                    chance: weatherForm.value.chance,
                    temp: `${weatherForm.value.tempHigh}/${weatherForm.value.tempLow}`
                };
            } else if (modalType.value === 'itinerary') {
                const list = itineraryData.value[selectedDateIndex.value];
                if(isEdit.value) {
                    const idx = list.findIndex(i => i.id === form.value.id);
                    if(idx !== -1) list[idx] = {...form.value};
                } else {
                    list.push({...form.value, id: Date.now()});
                    // Simple sort by time
                    list.sort((a,b) => (a.startTime||'').localeCompare(b.startTime||''));
                }
            } else if (modalType.value === 'list') {
                const targetList = currentTab.value === 'food' ? foodList : shoppingList;
                if(isEdit.value) targetList.value[editIndex.value] = {...form.value};
                else targetList.value.push({...form.value});
            } else if (modalType.value === 'expense') {
                expenses.value.push({...form.value});
            } else if (modalType.value === 'title') {
                // saved automatically via v-model, just close
            }
            closeModal();
            saveToStorage();
        };

        const removeListItem = (idx) => {
            if(!confirm('確定刪除?')) return;
            const targetList = currentTab.value === 'food' ? foodList : shoppingList;
            targetList.value.splice(idx, 1);
            saveToStorage();
        };

        const removeExpense = (idx) => { expenses.value.splice(idx, 1); saveToStorage(); };
        const removeFlight = (idx) => { flightList.value.splice(idx, 1); saveToStorage(); };
        const removeHotel = (idx) => { hotelList.value.splice(idx, 1); saveToStorage(); };
        const addNewDay = () => { dates.value.push({date:'New', weekday:'-'}); itineraryData.value.push([]); weatherData.value.push({condition:'sunny', temp:'20/15', chance:0}); };
        const removeLastDay = () => { if(dates.value.length>1) { dates.value.pop(); itineraryData.value.pop(); weatherData.value.pop(); }};

        const closeModal = () => { showModal.value = false; isEdit.value = false; editIndex.value = -1; };
        
        // --- Utilities ---
        const openMap = (name, address) => {
            const query = address || name;
            if(!query) return;
            // 嘗試開啟 Google Maps App Universal Link
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const encoded = encodeURIComponent(query);
            if(isMobile) {
                window.location.href = `https://www.google.com/maps/search/?api=1&query=${encoded}`;
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encoded}`, '_blank');
            }
        };

        const copyText = (text) => {
            navigator.clipboard.writeText(text).then(() => alert('已複製地址！')).catch(()=>alert('複製失敗'));
        };

        const formatNumber = (n) => (n||0).toLocaleString();
        
        const formatNoteWithLinks = (text) => {
            if (!text) return '';
            return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline" onclick="event.stopPropagation()">連結</a>').replace(/\n/g, '<br>');
        };

        const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        // --- Storage Logic (Backup/Restore) ---
        const saveToStorage = () => {
            const data = {
                tripSettings: tripSettings.value, dates: dates.value, itineraryData: itineraryData.value,
                weatherData: weatherData.value, foodList: foodList.value, shoppingList: shoppingList.value,
                expenses: expenses.value, flightList: flightList.value, hotelList: hotelList.value,
                exchangeRate: exchangeRate.value, memoText: memoText.value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        };

        const loadFromStorage = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                try {
                    const d = JSON.parse(saved);
                    if(d.tripSettings) tripSettings.value = d.tripSettings;
                    if(d.dates) dates.value = d.dates;
                    if(d.itineraryData) itineraryData.value = d.itineraryData;
                    if(d.weatherData) weatherData.value = d.weatherData;
                    if(d.foodList) foodList.value = d.foodList;
                    if(d.shoppingList) shoppingList.value = d.shoppingList;
                    if(d.expenses) expenses.value = d.expenses;
                    if(d.flightList) flightList.value = d.flightList;
                    if(d.hotelList) hotelList.value = d.hotelList;
                    if(d.exchangeRate) exchangeRate.value = d.exchangeRate;
                    if(d.memoText) memoText.value = d.memoText;
                } catch(e) { console.error(e); }
            }
        };

        const backupData = () => {
            const dataStr = localStorage.getItem(STORAGE_KEY);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fukuoka_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        const restoreData = (event) => {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    JSON.parse(e.target.result); // Validate JSON
                    localStorage.setItem(STORAGE_KEY, e.target.result);
                    alert('還原成功！網頁將重新整理。');
                    location.reload();
                } catch(err) { alert('檔案格式錯誤'); }
            };
            reader.readAsText(file);
        };

        const resetData = () => {
            if(confirm('警告：這將清空所有資料！確定嗎？')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        const openInfoModal = (type) => {
            // Placeholder functionality for Flight/Hotel modals in this simplified code
            alert('您可以直接在下方列表中點擊 X 刪除，或在上方 JSON 還原您原本的資料來新增。');
        };

        onMounted(() => {
            loadFromStorage();
            window.addEventListener('scroll', () => { showScrollTop.value = window.scrollY > 300; });
        });

        return {
            currentTab, dates, itineraryData, weatherData, foodList, shoppingList, expenses, flightList, hotelList,
            tripSettings, exchangeRate, currencyInput, currencyResult, totalExpensesJPY, totalExpensesTWD,
            memoText, parsedLinks, currentItinerary, selectedDateIndex, filteredList, currentCategories,
            searchQuery, selectedCategory, foodCategories, shoppingCategories, showScrollTop, showModal, modalType,
            form, weatherForm, isEdit,
            handleAddClick, editItem, editListItem, removeListItem, removeExpense, removeFlight, removeHotel,
            openWeatherModal, saveForm, closeModal, addNewDay, removeLastDay, openMap, copyText, scrollToTop,
            backupData, restoreData, resetData, openInfoModal, calculateCurrency:()=>{},
            getTabIcon, getTabLabel, getCategoryIcon, getCategoryColor, getWeatherIcon, getWeatherDescription, getTransportIcon,
            formatNumber, formatNoteWithLinks
        };
    }
}).mount('#app');
</script>

<style>
.input-field { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem; font-size: 0.875rem; outline: none; transition: all 0.2s; margin-bottom: 0.5rem; }
.input-field:focus { border-color: #01579B; box-shadow: 0 0 0 2px rgba(1, 87, 155, 0.1); }
</style>
</body>
</html>
