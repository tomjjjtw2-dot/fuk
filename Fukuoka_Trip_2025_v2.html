<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fukuoka Trip Dec 2025 (Optimized)</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="福岡之旅">

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'snow-white': '#F0FFFF', 'ice-blue': '#B3E5FC', 'light-snow-blue': '#E5F3F7',
                'deep-sea-blue': '#01579B', 'accent-yellow': '#FFD54F', 'soft-gray': '#F5F5F5',
                'warm-beige': '#FFF8E7', 'warm-brown': '#5D4037'
            }
        }
    }
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
body { background-color: #FFF8E7; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
.app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(93, 64, 55, 0.05); position: relative; padding-bottom: 100px; }
.header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; }
.header-image-container { width: 100%; height: 320px; overflow: hidden; background-color: #FFF8E7; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; position: relative; }
.header-image-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
.title-overlay { position: absolute; bottom: 40px; left: 20px; color: #5D4037; text-shadow: 0 2px 15px rgba(255, 255, 255, 0.9), 0 0 5px rgba(255, 255, 255, 1); z-index: 20; width: 80%; }
.app-main { padding-top: 25px !important; position: relative; z-index: 5; }
.hide-scrollbar::-webkit-scrollbar { display: none; }
.card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease, box-shadow 0.2s ease; }
.animate-fade-in { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fab-shadow { box-shadow: 0 4px 15px rgba(255, 213, 79, 0.5); }
.expense-category-tag { min-width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
.expenses-banner { background: linear-gradient(135deg, #01579B 0%, #0097A7 100%); }
.date-selector-sticky { background-color: #ffffff; border-bottom: 1px solid #f0f0f0; z-index: 20; top: 0; }
.checkbox-wrapper input:checked + div { background-color: #01579B; border-color: #01579B; }
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }
.category-pill { padding: 6px 14px; border-radius: 999px; font-size: 12px; font-weight: bold; white-space: nowrap; transition: all 0.2s; border: 1px solid transparent; }
.category-pill.active { background-color: #01579B; color: white; box-shadow: 0 2px 8px rgba(1, 87, 155, 0.3); }
.category-pill:not(.active) { background-color: white; color: #64748b; border-color: #e2e8f0; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
</style>
</head>
<body>

<div id="app" class="app-container">

    <div class="header-bg relative">
        <div class="header-image-container">
            <video autoplay loop muted playsinline poster="https://images.unsplash.com/photo-1629636608529-6886e7a2b02e?q=80&w=1000">
                <source src="fuk.mp4" type="video/mp4">
            </video>
            
            <div class="title-overlay">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold">{{ tripSettings.title }}</h1>
                    <button @click="showTitleModal = true" class="ml-2 bg-white/30 backdrop-blur-sm p-1.5 rounded-full hover:bg-white/50 transition-colors">
                        <i class="fa-solid fa-pencil text-sm text-white"></i>
                    </button>
                </div>
                <p class="text-sm font-bold mt-1 text-slate-700">{{ tripSettings.subtitle }}</p>
            </div>
        </div>
        <button @click="currentTab = 'info'" class="absolute top-4 right-4 z-30 bg-white/20 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/30 shadow-lg">
            <i class="fa-solid fa-gear"></i>
        </button>
    </div>

    <main class="p-4 app-main">

        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4 items-center">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                    class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                    :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                    <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span>
                    <span class="text-xs font-medium opacity-70">{{ day.date }}</span>
                </div>
                <div class="flex flex-col space-y-1 ml-1 pl-2 border-l border-slate-100">
                    <button @click="addNewDay" class="w-8 h-8 rounded-full bg-slate-100 text-deep-sea-blue hover:bg-deep-sea-blue hover:text-white transition-colors flex items-center justify-center shadow-sm"><i class="fa-solid fa-plus text-xs"></i></button>
                    <button v-if="dates.length > 1" @click="removeLastDay" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-100 hover:text-red-500 transition-colors flex items-center justify-center shadow-sm"><i class="fa-solid fa-minus text-xs"></i></button>
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" @click="openWeatherModal" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md cursor-pointer hover:shadow-lg transition-all">
                <div class="flex items-start text-deep-sea-blue space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-5xl text-blue-500"></i>
                    <div class="pt-1">
                         <span class="text-3xl font-extrabold leading-none">{{ weatherData[selectedDateIndex].temp.split('/')[0] }}°</span>
                        <span class="text-sm font-light text-slate-500 ml-1">/ {{ weatherData[selectedDateIndex].temp.split('/')[1] }}°C</span>
                        <span class="block text-xs text-slate-600 mt-1">降雨率: {{ weatherData[selectedDateIndex].chance }}%</span>
                    </div>
                </div>
                <div class="text-right text-xs text-slate-600 pl-3 flex flex-col items-end">
                    <span class="font-bold block text-slate-700 text-lg">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    <span class="mt-1 block text-slate-400 mb-1"><i class="fa-solid fa-pen mr-1"></i>點擊修改天氣</span>
                </div>
            </div>

            <div class="space-y-4">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                         <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
                           <i :class="getTransportIcon(currentItinerary[idx].transportType)" class="mr-2 text-slate-300 cursor-pointer hover:text-deep-sea-blue transition-colors"
                           @click="openMapDirections(currentItinerary[idx - 1], item)"></i>
                        <span class="font-bold">{{ item.travelTime || '移動中' }}</span>
                    </div>

                    <div class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-ice-blue/50">
                        <div class="mr-4 flex flex-col items-center flex-shrink-0" style="width: 80px;">
                             <div v-if="item.image" class="w-20 h-20 rounded-2xl shadow-md overflow-hidden mb-1 border border-slate-100">
                                <img :src="item.image" class="w-full h-full object-cover">
                            </div>
                            <div v-else class="w-20 h-20 rounded-2xl shadow-md flex items-center justify-center text-3xl mb-1 text-white transition-colors" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                             <span v-if="item.startTime" class="text-xs font-bold text-slate-600 mt-1">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 pb-1 min-w-0">
                            <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight pr-8">{{ item.name }}</h3>
                             <div class="text-sm text-slate-500 space-y-1.5 mt-2">
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-ice-blue"></i> {{ item.hours }}</p>
                                <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-ice-blue"></i> {{ item.price }}</p>
                                <p v-if="item.address" class="flex items-start">
                                    <i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-ice-blue"></i> 
                                    <span class="truncate">{{ item.address }}</span>
                                    <button @click.stop="copyText(item.address)" class="ml-2 text-blue-400 hover:text-blue-600"><i class="fa-regular fa-copy"></i></button>
                                </p>
                            </div>

                            <div v-if="item.note && item.note.length > 0" class="mt-3 text-xs bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                <p class="text-slate-600 font-bold mb-1 flex items-center"><i class="fa-solid fa-highlighter text-accent-yellow mr-2"></i> 備註</p>
                               <div class="whitespace-pre-line leading-relaxed text-slate-500 transition-all duration-300"
                                     :class="item.isNoteExpanded ? 'max-h-60 overflow-y-auto custom-scrollbar p-1' : 'max-h-12 overflow-hidden'"
                                     v-html="formatNoteWithLinks(item.note)">
                                </div>
                                <button v-if="item.note.length > 30" @click.stop="item.isNoteExpanded = !item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-2 w-full text-center py-1 rounded hover:bg-blue-50 transition-colors text-[10px]">
                                    <i class="fa-solid" :class="item.isNoteExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    {{ item.isNoteExpanded ? ' 收合備註' : ' 展開閱讀完整內容' }}
                                </button>
                             </div>
                        </div>

                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button v-if="idx > 0" @click.stop="moveItineraryUp(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300"><i class="fa-solid fa-arrow-up"></i></button>
                            <button v-if="idx < currentItinerary.length - 1" @click.stop="moveItineraryDown(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300"><i class="fa-solid fa-arrow-down"></i></button>
                            <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-ice-blue text-deep-sea-blue rounded-full flex items-center justify-center text-xs hover:bg-deep-sea-blue hover:text-white"><i class="fa-solid fa-location-arrow"></i></button>
                             <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-200"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentItinerary.length === 0" class="text-center py-16 text-slate-300">
                <i class="fa-solid fa-map-location-dot text-5xl mb-3 text-slate-200"></i>
                <p class="text-sm">本日尚無行程<br>請點擊下方新增</p>
            </div>
        </div>

        <div v-if="currentTab === 'food'" class="animate-fade-in">
             <div class="sticky top-0 bg-[#FFF8E7] z-10 pb-2 pt-1">
                <div class="relative mb-2">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input v-model="foodSearchQuery" type="text" placeholder="搜尋美食 (例如: 拉麵, 布丁...)" class="w-full bg-white rounded-xl py-3 pl-10 pr-4 shadow-sm text-sm focus:ring-2 focus:ring-deep-sea-blue outline-none border border-slate-100">
                    <button v-if="foodSearchQuery" @click="foodSearchQuery = ''" class="absolute right-3 top-3 text-slate-300 hover:text-slate-500"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 px-1 pb-1">
                    <button v-for="cat in foodCategories" :key="cat" @click="selectedFoodCategory = cat" :class="['category-pill', selectedFoodCategory === cat ? 'active' : '']">{{ cat }}</button>
                </div>
            </div>

             <div class="grid grid-cols-2 gap-4 mt-2">
                  <div v-for="(item, idx) in filteredFoodList" :key="item.originalIndex" 
                     class="bg-white rounded-2xl p-3 card-shadow relative group cursor-pointer hover:shadow-lg transition-all"
                     @click="openMap(item.address || item.name)"> 
                    <div class="aspect-square bg-slate-50 rounded-xl mb-3 overflow-hidden relative border border-slate-100">
                         <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-utensils text-3xl"></i></div>
                        <div v-if="item.type" class="absolute top-2 left-2 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full font-bold">{{ item.type }}</div>
                        <div class="absolute bottom-2 right-2 bg-white/80 rounded-full w-6 h-6 flex items-center justify-center text-deep-sea-blue text-xs shadow-sm"><i class="fa-solid fa-location-arrow"></i></div>
                         <button @click.stop="removeFoodItem(item.originalIndex)" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-20 hover:bg-red-500"><i class="fa-solid fa-xmark"></i></button>
                         <button @click.stop="editFoodItem(item.originalIndex)" class="absolute top-2 left-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-20 hover:bg-deep-sea-blue"><i class="fa-solid fa-pencil"></i></button>
                    </div>
                    <p class="font-bold text-sm text-slate-800 truncate px-1">{{ item.name }}</p>
                    <p class="text-[10px] text-slate-400 px-1 mt-0.5 truncate flex items-center" v-if="item.address">
                        <i class="fa-solid fa-map-pin mr-1"></i>{{ item.address }}
                        <i class="fa-regular fa-copy ml-auto mr-1 cursor-pointer hover:text-blue-500" @click.stop="copyText(item.address)"></i>
                    </p>
                    <p class="text-[10px] text-slate-500 px-1 mt-1 line-clamp-2 h-8" v-if="item.note">{{ item.note }}</p>
                  </div>
                <div v-if="foodList.length === 0" class="col-span-2 text-center py-16 text-slate-300">
                    <i class="fa-solid fa-utensils text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">美食清單空白</p>
                </div>
             </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="animate-fade-in">
             <div class="sticky top-0 bg-[#FFF8E7] z-10 pb-2 pt-1">
                <div class="relative mb-2">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input v-model="shoppingSearchQuery" type="text" placeholder="搜尋購物清單..." class="w-full bg-white rounded-xl py-3 pl-10 pr-4 shadow-sm text-sm focus:ring-2 focus:ring-deep-sea-blue outline-none border border-slate-100">
                    <button v-if="shoppingSearchQuery" @click="shoppingSearchQuery = ''" class="absolute right-3 top-3 text-slate-300 hover:text-slate-500"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 px-1 pb-1">
                    <button v-for="cat in shoppingCategories" :key="cat" @click="selectedShoppingCategory = cat" :class="['category-pill', selectedShoppingCategory === cat ? 'active' : '']">{{ cat }}</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-2">
                 <div v-for="(item, idx) in filteredShoppingList" :key="item.originalIndex" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="w-[80%] mx-auto h-32 bg-slate-50 rounded-xl mb-2 overflow-hidden relative border border-slate-100 mt-2">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-bag-shopping text-3xl"></i></div>
                        <div v-if="item.type" class="absolute top-1 left-1 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full font-bold">{{ item.type }}</div>
                    </div>
                    <button @click.stop="removeShoppingItem(item.originalIndex)" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-20 hover:bg-red-500"><i class="fa-solid fa-xmark"></i></button>
                    <button @click.stop="editShoppingItem(item.originalIndex)" class="absolute top-2 left-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-20 hover:bg-deep-sea-blue"><i class="fa-solid fa-pencil"></i></button>
                    <p class="font-bold text-sm text-slate-800 truncate px-1 text-center mb-1">{{ item.name }}</p>
                    <div class="bg-slate-50 rounded-lg p-2 h-20 overflow-y-auto custom-scrollbar">
                        <p class="text-[10px] text-slate-500 leading-relaxed whitespace-pre-line">{{ item.note }}</p>
                     </div>
                </div>
                <div v-if="shoppingList.length === 0" class="col-span-2 text-center py-16 text-slate-300">
                    <i class="fa-solid fa-bag-shopping text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">購物清單空白</p>
              </div>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-fade-in">
            <div class="expenses-banner text-white rounded-3xl p-8 mb-6 relative overflow-hidden">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                 <div class="absolute -left-10 -bottom-10 bg-ice-blue/20 w-40 h-40 rounded-full blur-2xl"></div>
                <p class="text-sm text-cyan-200 mb-2 relative z-10">目前總花費 (JPY)</p>
                <h2 class="text-5xl font-bold relative z-10 tracking-tight">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-right mt-2 opacity-80 relative z-10">約 NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>

             <div class="bg-white rounded-t-3xl min-h-[500px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-slate-800 mb-5 flex items-center">
                    <i class="fa-solid fa-receipt text-slate-300 mr-2"></i>支出紀錄
                </h3>
                <div class="space-y-5">
                   <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between border-b border-slate-50 pb-4 last:border-0">
                        <div class="flex items-center">
                            <div class="expense-category-tag mr-4 text-white" :class="getCategoryColor(exp.category)">{{ getCategoryLabel(exp.category) }}</div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm mb-0.5">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400 uppercase tracking-wide">{{ exp.date }} · {{ exp.payment === 'card' ? '信用卡' : '現金' }}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center">
                            <p class="font-bold text-slate-700">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="w-5 h-5 ml-3 text-red-300 hover:text-red-500 transition-colors flex items-center justify-center"><i class="fa-solid fa-xmark text-lg"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in pb-20">
            <div class="bg-slate-800 rounded-3xl p-6 text-white shadow-xl relative">
                <h3 class="font-bold text-lg mb-3"><i class="fa-solid fa-cloud-arrow-up mr-2 text-accent-yellow"></i>資料備份與還原</h3>
                <p class="text-xs text-slate-400 mb-4">建議出發前備份一次，將行程存成檔案。若更換手機，可直接還原。</p>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="backupData" class="bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm shadow transition-colors">
                        <i class="fa-solid fa-download mr-1"></i> 下載備份
                    </button>
                    <div class="relative">
                        <input type="file" id="restoreFile" @change="restoreData" class="hidden" accept=".json">
                        <label for="restoreFile" class="block w-full text-center bg-slate-600 hover:bg-slate-500 py-3 rounded-xl font-bold text-sm cursor-pointer transition-colors">
                            <i class="fa-solid fa-upload mr-1"></i> 還原備份
                        </label>
                    </div>
                </div>
                <button @click="resetData" class="w-full mt-4 text-xs text-red-400 hover:text-red-300 py-2 underline">重置所有資料 (清空)</button>
            </div>

            <div class="bg-gradient-to-r from-deep-sea-blue to-cyan-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                <div class="flex items-center justify-between space-x-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1 uppercase tracking-wider">JPY</label>
                        <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white text-lg font-bold placeholder-white/50 focus:outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-cyan-300 mt-5"></i>
                    <div class="flex-1">
                         <label class="text-[10px] text-cyan-200 block mb-1 uppercase tracking-wider">TWD</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2.5 text-white text-lg font-bold">$ {{ currencyResult }}</div>
                    </div>
                </div>
                <div class="flex justify-end items-center mt-3 relative z-10 space-x-2">
                    <label class="text-[10px] text-cyan-200">匯率:</label>
                    <input type="number" v-model="exchangeRate" @input="calculateCurrency" step="0.001" class="w-20 bg-white/20 border border-white/30 rounded-lg px-2 py-1 text-white text-xs text-center font-bold">
                </div>
            </div>

            <div class="bg-white rounded-3xl p-5 card-shadow relative">
                <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                     <h3 class="font-bold text-slate-800"><i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> 航班與住宿</h3>
                     <div class="flex space-x-2">
                        <button @click="openInfoModal('flight')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-bold">+ 航班</button>
                        <button @click="openInfoModal('hotel')" class="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded-full font-bold">+ 住宿</button>
                    </div>
                </div>
                <div class="space-y-4">
                      <div v-for="(flight, idx) in flightList" :key="idx" class="bg-blue-50 rounded-xl p-3 border border-blue-100 relative group">
                        <button @click="removeFlight(idx)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 z-10 p-1"><i class="fa-solid fa-xmark"></i></button>
                        <div @click="editInfoItem('flight', flight, idx)" class="cursor-pointer">
                             <div class="flex justify-between text-sm font-bold text-deep-sea-blue mb-1 pr-6">
                                 <span>{{ flight.origin }}</span><i class="fa-solid fa-plane text-xs"></i><span>{{ flight.dest }}</span>
                             </div>
                            <div class="flex justify-between text-xs text-slate-500">
                                 <span>{{ flight.depTime }}</span><span>{{ flight.code }}</span><span>{{ flight.arrTime }}</span>
                             </div>
                        </div>
                     </div>
                     <div v-for="(hotel, idx) in hotelList" :key="idx" class="bg-purple-50 rounded-xl p-3 border border-purple-100 relative">
                        <button @click="removeHotel(idx)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 z-10 p-1"><i class="fa-solid fa-xmark"></i></button>
                        <div class="cursor-pointer" @click="editInfoItem('hotel', hotel, idx)">
                             <span class="font-bold block text-slate-700 text-sm">{{ hotel.name }}</span>
                             <span class="text-xs text-slate-400 bg-white px-2 py-0.5 rounded-full inline-block mt-1 border">{{ hotel.date }}</span>
                        </div>
                        <div class="flex items-center mt-2" v-if="hotel.address">
                            <button @click.stop="openMap(hotel.name)" class="w-6 h-6 mr-2 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center hover:bg-indigo-500 hover:text-white transition-all flex-shrink-0"><i class="fa-solid fa-location-arrow text-[10px]"></i></button>
                            <p class="text-xs text-slate-500 truncate">{{ hotel.address }}</p>
                        </div>
                    </div>
                 </div>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-clipboard-check text-green-500 mr-2"></i>行前準備</h3>
                <ul class="space-y-2 mb-4">
                    <li v-for="(item, idx) in checkList" :key="idx" class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors group">
                        <div class="flex items-center cursor-pointer flex-1" @click="item.checked = !item.checked">
                             <div class="checkbox-wrapper relative w-5 h-5 mr-3 flex-shrink-0">
                                <input type="checkbox" v-model="item.checked" class="absolute opacity-0 w-full h-full cursor-pointer">
                                 <div class="w-5 h-5 border-2 border-slate-300 rounded-md transition-all flex items-center justify-center bg-white text-white">
                                    <i class="fa-solid fa-check text-xs" v-show="item.checked"></i>
                                </div>
                             </div>
                            <span :class="{'line-through text-slate-400': item.checked, 'text-slate-700': !item.checked}" class="text-sm font-medium select-none">{{ item.text }}</span>
                        </div>
                         <button @click="removeChecklistItem(idx)" class="text-slate-300 hover:text-red-500 p-1 rounded-full transition-colors"><i class="fa-solid fa-trash-can text-sm"></i></button>
                     </li>
                 </ul>
                 <div class="flex space-x-2 pt-2 border-t border-slate-100">
                    <input v-model="newChecklistItem" @keyup.enter="addChecklistItem" type="text" placeholder="新增檢查項目..." class="flex-1 bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-deep-sea-blue outline-none">
                    <button @click="addChecklistItem" class="bg-deep-sea-blue text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md"><i class="fa-solid fa-plus text-sm"></i></button>
                </div>
            </div>

             <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-pen-to-square text-accent-yellow mr-2"></i>個人備忘錄</h3>
                <textarea v-model="memoText" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue mb-3 min-h-[100px]" placeholder="輸入文字或網址..."></textarea>
                 <div v-if="parsedLinks.length > 0" class="flex flex-wrap gap-2 mt-2">
                    <a v-for="(link, lIdx) in parsedLinks" :key="lIdx" :href="link" target="_blank" class="bg-ice-blue text-deep-sea-blue px-3 py-2 rounded-lg text-xs font-bold flex items-center hover:bg-deep-sea-blue hover:text-white transition-colors">
                        <i class="fa-solid fa-link mr-2"></i> 連結 {{ lIdx + 1 }}
                     </a>
                </div>
             </div>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-2 flex justify-between items-center z-50 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.03)] max-w-[480px] mx-auto">
        <button v-for="tab in ['itinerary', 'food', 'shopping', 'expenses']" :key="tab" @click="currentTab = tab" 
            class="flex flex-col items-center justify-center w-12 transition-all" :class="currentTab === tab ? 'text-deep-sea-blue' : 'text-slate-300'">
            <i class="text-xl mb-1 transition-transform" :class="[getTabIcon(tab), currentTab === tab ? 'scale-110' : '']"></i>
            <span class="text-[10px] font-bold">{{ getTabLabel(tab) }}</span>
        </button>
    </div>

    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-[90px] right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-[60] border-4 border-white">
        <i class="fa-solid fa-plus"></i>
    </button>
    
    <button v-show="showScrollTop" @click="scrollToTop" class="fixed bottom-[160px] right-8 w-10 h-10 bg-white/90 backdrop-blur text-slate-500 rounded-full shadow border border-slate-200 flex items-center justify-center z-50">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <div v-if="showModal" @click.self="closeModal" class="fixed inset-0 bg-deep-sea-blue/40 z-[70] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">{{ modalTitle }}</h3>
            
            <div class="space-y-4">
                 <template v-if="modalType === 'itinerary'">
                    <select v-model="form.category" class="input-field"><option value="sightseeing">景點</option><option value="food">飲食</option><option value="shopping">購物</option><option value="transport">交通</option><option value="other">其他</option></select>
                    <input v-model="form.name" placeholder="名稱" class="input-field">
                    <input v-model="form.address" placeholder="地址" class="input-field">
                    <div class="grid grid-cols-2 gap-3">
                         <input v-model="form.startTime" type="time" class="input-field">
                         <input v-model="form.travelTime" placeholder="移動時間" class="input-field">
                    </div>
                    <textarea v-model="form.note" placeholder="備註" class="input-field h-24"></textarea>
                </template>

                <template v-if="modalType === 'list'">
                    <input v-model="form.name" placeholder="名稱" class="input-field">
                    <select v-model="form.type" class="input-field">
                         <option v-for="c in (currentTab==='food'?foodCategories:shoppingCategories).filter(c=>c!=='全部')" :value="c">{{c}}</option>
                    </select>
                    <input v-if="currentTab==='food'" v-model="form.address" placeholder="地址" class="input-field">
                    <input v-model="form.image" placeholder="圖片網址" class="input-field">
                    <textarea v-model="form.note" placeholder="備註" class="input-field h-24"></textarea>
                </template>
                
                 <template v-if="modalType === 'expense'">
                    <div class="grid grid-cols-2 gap-3"><input v-model="form.date" type="date" class="input-field"><select v-model="form.category" class="input-field"><option value="food">飲食</option><option value="shopping">購物</option><option value="transport">交通</option><option value="ticket">門票</option><option value="other">其他</option></select></div>
                    <input v-model="form.name" placeholder="項目名稱" class="input-field">
                    <input v-model.number="form.amount" type="number" placeholder="金額 (JPY)" class="input-field font-bold text-lg">
                    <div class="flex gap-2"><button @click="form.payment='cash'" :class="form.payment==='cash'?'bg-deep-sea-blue text-white':'bg-slate-100'" class="flex-1 py-2 rounded-lg">現金</button><button @click="form.payment='card'" :class="form.payment==='card'?'bg-deep-sea-blue text-white':'bg-slate-100'" class="flex-1 py-2 rounded-lg">信用卡</button></div>
                </template>

                <template v-if="modalType === 'weather'">
                    <p class="text-center mb-2 font-bold">{{ dates[selectedDateIndex]?.date }} 天氣設定</p>
                    <select v-model="weatherForm.condition" class="input-field"><option value="sunny">晴天</option><option value="cloudy">多雲</option><option value="rain">下雨</option><option value="snow">下雪</option></select>
                    <div class="flex gap-2 items-center">
                        <input v-model="weatherForm.high" type="number" placeholder="最高溫" class="input-field"><span>/</span><input v-model="weatherForm.low" type="number" placeholder="最低溫" class="input-field">
                    </div>
                    <input v-model="weatherForm.chance" type="number" placeholder="降雨機率 %" class="input-field">
                </template>
                 <template v-if="modalType === 'title'">
                     <input v-model="tripSettings.title" class="input-field" placeholder="主標題">
                     <input v-model="tripSettings.subtitle" class="input-field" placeholder="副標題">
                </template>
                 <template v-if="modalType === 'info'">
                     <input v-if="infoFormType==='flight'" v-model="infoForm.origin" placeholder="出發地" class="input-field">
                     <input v-if="infoFormType==='flight'" v-model="infoForm.dest" placeholder="目的地" class="input-field">
                     <input v-if="infoFormType==='flight'" v-model="infoForm.code" placeholder="航班代號" class="input-field">
                     <div v-if="infoFormType==='flight'" class="flex gap-2"><input v-model="infoForm.depTime" placeholder="起飛" class="input-field"><input v-model="infoForm.arrTime" placeholder="抵達" class="input-field"></div>
                     <input v-if="infoFormType==='hotel'" v-model="infoForm.name" placeholder="飯店名稱" class="input-field">
                     <input v-if="infoFormType==='hotel'" v-model="infoForm.address" placeholder="地址" class="input-field">
                     <input v-if="infoFormType==='hotel'" v-model="infoForm.date" placeholder="入住日期" class="input-field">
                </template>
            </div>

            <div class="flex space-x-3 mt-6">
                <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="saveForm" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue

createApp({
    setup() {
        const STORAGE_KEY = 'fukuoka_trip_2025_optimized_v2';
        const currentTab = ref('itinerary');
        const showScrollTop = ref(false);
        const tripSettings = ref({ title: 'Fukuoka', subtitle: '12/13 - 12/17 聖誕市集之旅' });
        const dates = ref([ { date: '12/13', weekday: '六' }, { date: '12/14', weekday: '日' }, { date: '12/15', weekday: '一' }, { date: '12/16', weekday: '二' }, { date: '12/17', weekday: '三' } ]);
        
        // 保留使用者原始資料
        const hotelList = ref([{"name": "HOTEL WA HAKATA", "date": "12/13 - 12/17", "address": "7-3 Tenyamachi, Hakata Ward, Fukuoka, 812-0025日本", "phone": "+81 92-409-4892"}]);
        const flightList = ref([{"origin": "TPE 桃園", "dest": "FUK 福岡", "depTime": "06:45", "arrTime": "10:00", "code": "IT240"}, {"origin": "FUK 福岡", "dest": "TPE 桃園", "code": "JX841", "depTime": "19:10", "arrTime": "20:50"}]);
        const itineraryData = ref([
            [{"id": 101, "name": "桃園機場報到", "category": "flight", "startTime": "04:45", "address": "桃園國際機場 T1", "note": "Tigerair IT240 06:45起飛", "image": "images/fu-1.jpg"}, {"id": 102, "name": "福岡機場 (FUK) 抵達", "category": "flight", "startTime": "10:00", "address": "福岡機場", "note": "入境審查、領取行李", "travelTime": "2h15m", "image": "images/fu-2.jpg"}, {"id": 103, "name": "前往飯店 Check-in/寄放行李", "category": "accommodation", "startTime": "11:00", "address": "HOTEL WA HAKATA", "note": "先安置行李", "travelTime": "20m", "image": "images/fu-3.jpg"}, {"id": 104, "name": "博多運河城", "category": "shopping", "startTime": "12:00", "address": "博多運河城", "note": "水舞秀(每30分)、3F MUJI、2F迪士尼商店\n、B1動漫IP/扭蛋(萬代)。\n官網：https://canalcity.co.jp/zh-tw", "hours": "10:00-21:00", "travelTime": "12m", "image": "images/fu-4.jpg", "isNoteExpanded": true}, {"id": 105, "name": "中央光之森林", "category": "sightseeing", "startTime": "19:00", "address": "天神中央公園", "note": "透過眾多裝飾、燈光璀璨營造出夢幻般的氛圍", "hours": "12:00-23:00", "travelTime": "20m", "image": "images/fu-21.jpg"}],
            [{"id": 201, "name": "天神地下街", "category": "shopping", "startTime": "10:00", "address": "天神地下街", "note": "九州最大地下街，150家店舖。", "hours": "10:00-21:00", "transportType": "public", "travelTime": "15m", "image": "images/fu-6.jpg"}, {"id": 202, "name": "百貨巡禮 (岩田屋/三越/大丸)", "category": "shopping", "startTime": "13:00", "address": "岩田屋本店", "note": "岩田屋(B2/3F/6F連通)\n大丸(B2甜點:福砂屋/明月堂/如水庵)。", "hours": "10:00-20:00", "travelTime": "5m", "image": "images/fu-7.jpg"}, {"id": 203, "name": "福岡PARCO", "category": "shopping", "startTime": "15:00", "address": "福岡PARCO", "note": "年輕潮牌、動畫周邊與生活風格選物集中地。", "hours": "10:00-20:30", "travelTime": "5m", "image": "images/fu-8.jpg"}, {"id": 204, "name": "Mina 天神", "category": "shopping", "startTime": "16:30", "address": "Mina 天神", "note": "九州最大 UNIQLO、GU、LOFT。", "hours": "10:00-20:00", "travelTime": "5m", "image": "images/fu-9.jpg"}, {"id": 205, "name": "晚餐: Nikuichi (燒肉)", "category": "food", "startTime": "17:30", "address": "にく屋 肉いち", "note": "預約時間 17:30。必點7種盛合。", "hours": "16:00-00:00", "transportType": "public", "travelTime": "20m", "image": "images/fu-10.jpg"}, {"id": 206, "name": "博多聖誕市集-光之街", "category": "sightseeing", "startTime": "19:00", "address": "JR博多站前廣場", "note": "續攤感受不同於博多的聖誕氣氛。", "hours": "12:00~23:00", "travelTime": "15m", "image": "images/fu-5.jpg"}],
            [{"id": 301, "name": "前往太宰府", "category": "transport", "startTime": "10:00", "address": "太宰府站", "note": "搭乘西鐵電車前往(9點出門)。", "transportType": "public", "travelTime": "40m", "image": "images/fu-12.jpg"}, {"id": 302, "name": "寶滿宮 竈門神社", "category": "sightseeing", "startTime": "10:40", "address": "寶滿宮 竈門神社", "note": "太宰府站轉搭巴士「往內山」。", "hours": "08:30-18:00", "transportType": "bus", "travelTime": "10m", "image": "images/fu-13.jpg"}, {"id": 303, "name": "天開稻荷神社", "category": "sightseeing", "startTime": "11:30", "address": "天開稻荷神社", "note": "九州最古老稻荷神社。", "hours": "06:30-18:30", "travelTime": "30m", "image": "images/fu-14.jpg"}, {"id": 304, "name": "太宰府天滿宮 & 表參道", "category": "sightseeing", "startTime": "13:00", "address": "太宰府天滿宮", "note": "御神牛、太鼓橋、隈研吾星巴克、梅枝餅。", "hours": "06:30-19:00", "travelTime": "10m", "image": "images/fu-15.jpg"}, {"id": 305, "name": "前往 LaLaport 福岡", "category": "transport", "startTime": "15:00", "address": "LaLaport 福岡", "note": "搭乘西鐵/巴士前往。", "transportType": "public", "travelTime": "50m", "image": "images/fu-16.jpg"}, {"id": 307, "name": "晚餐: 博多華味鳥 (水炊鍋)", "category": "food", "startTime": "18:15", "address": "水たき料亭 博多華味鳥 川端通り店", "note": "預約時間 18:15 (10大2小)。", "hours": "17:00-23:00", "transportType": "public", "travelTime": "40m", "image": "images/fu-17.jpg"}, {"id": 1764922841025, "name": "天神聖誕市集", "category": "sightseeing", "startTime": "20:00", "hours": "12:00~23:00", "address": "福岡市政府西側交流廣場", "note": "穿過拱門，映入眼簾的是一個沐浴在光芒中的世界", "travelTime": "15m", "image": "images/fu-11.jpg"}],
            [{"id": 401, "name": "櫛田神社", "category": "sightseeing", "startTime": "10:00", "address": "櫛田神社", "note": "博多總鎮守，展示山笠。", "hours": "09:00-17:00", "price": "免費", "transportType": "public", "travelTime": "20m", "image": "images/fu-18.jpg"}, {"id": 402, "name": "博多車站周邊購物", "category": "shopping", "startTime": "~11:30", "address": "JR博多城", "note": "AMU PLAZA(Hands)、博多阪急、KITTE博多。", "hours": "10:00-20:00", "transportType": "public", "travelTime": "10m", "image": "images/fu-19.jpg"}, {"id": 404, "name": "福岡塔", "category": "sightseeing", "startTime": "16:30", "address": "福岡塔", "note": "日本最高海濱塔，冬季聖誕樹主題燈飾。", "hours": "09:30-22:00", "price": "¥1000", "transportType": "public", "travelTime": "40m", "image": "images/fu-20.jpg"}, {"id": 405, "name": "天神屋台", "category": "sightseeing", "startTime": "19:30", "address": "天神屋台", "note": "體驗屋台文化", "transportType": "bus", "travelTime": "30m", "image": ""}],
            [{"id": 501, "name": "Check-out", "category": "accommodation", "startTime": "10:00", "address": "hotel wa hakata", "note": "辦理退房，寄放行李。", "image": null}, {"id": 502, "name": "大濠公園 & 星巴克", "category": "sightseeing", "startTime": "11:00", "address": "大濠公園", "note": "都市綠洲，湖畔星巴克喝咖啡。", "transportType": "public", "travelTime": "30m", "image": "images/fu-22.jpg"}, {"id": 503, "name": "壹岐神社 (備案)", "category": "sightseeing", "startTime": "~13:00", "address": "壱岐神社 一の鳥居", "note": "海邊鳥居，散步聽海浪。", "transportType": "public", "travelTime": "30m", "image": "images/fu-23.jpg"}, {"id": 504, "name": "前往福岡機場", "category": "transport", "startTime": "15:00", "address": "福岡機場", "note": "預備搭機返台。", "transportType": "public", "travelTime": "40m", "image": "images/fu-2.jpg"}, {"id": 505, "name": "返程班機", "category": "flight", "startTime": "待定", "address": "福岡機場", "note": "平安歸賦。", "transportType": "flight", "image": null}]
        ]);
        const shoppingList = ref([
            {"name": "明月堂博多TORIMON", "image": "images/BUY-1.jpg", "type": "伴手禮", "note": "福岡最經典最具代表性的伴手禮。"}, {"name": "東雲堂 二〇加煎餅", "image": "images/BUY-2.jpg", "type": "伴手禮", "note": "半臉面具煎餅。"}, {"name": "太宰府梅枝餅", "image": "images/BUY-3.jpg", "type": "伴手禮", "note": "太宰府名物。"}, {"name": "福太郎 明太子仙貝", "image": "images/BUY-4.jpg", "type": "伴手禮", "note": "福太郎的代表商品。"}, {"name": "博多風美庵 明太子蝦餅", "image": "images/BUY-5.jpg", "type": "伴手禮", "note": "酥脆口感。"}, {"name": "明太子名店ふくや", "image": "images/BUY-6.jpg", "type": "伴手禮", "note": "tubetube明太子醬。"}, {"name": "如水庵 筑紫もち", "image": "images/BUY-7.jpg", "type": "甜點", "note": "筑紫麻糬。"}, {"name": "石村萬盛堂 鶴乃子", "image": "images/BUY-8.jpg", "type": "甜點", "note": "棉花糖包覆蛋黃內餡。"}, {"name": "吉野堂 ひよ子のたまご", "image": "images/BUY-9.jpg", "type": "甜點", "note": "小雞蛋糕福岡限定口味。"}, {"name": "左衛門 博多ぶらぶら", "image": "images/BUY-10.jpg", "type": "甜點", "note": "北海道紅豆包覆求肥。"}, {"name": "鈴懸 鈴乃〇餅", "image": "images/BUY-11.jpg", "type": "甜點", "note": "鈴懸代表性商品。"}, {"name": "隆勝堂 鯛最中", "image": "images/BUY-12.jpg", "type": "甜點", "note": "吉祥寓意。"}, {"name": "久原本家 茅乃舍だし", "image": "images/BUY-13.jpg", "type": "調味料", "note": "方便煮出道地高湯。"}, {"name": "二鶴堂 博多の女", "image": "images/BUY-15.jpg", "type": "甜點", "note": "年輪蛋糕包裹羊羹。"}, {"name": "三日月 可頌麵包", "image": "images/BUY-16.jpg", "type": "麵包", "note": "天然酵母製作。"}, {"name": "さかえ屋 なんばん往来", "image": "images/BUY-17.jpg", "type": "甜點", "note": "南蠻文化與九州食材結合。"}, {"name": "chiffon cake MARIE", "image": "images/BUY-18.jpg", "type": "蛋糕", "note": "濕潤鬆軟戚風蛋糕。"}, {"name": "Chocolateshop 博多の石畳", "image": "images/BUY-19.jpg", "type": "巧克力", "note": "生巧克力。"}, {"name": "PRESS BUTTER SAND", "image": "images/BUY-20.jpg", "type": "伴手禮", "note": "甘王草莓口味。"}, {"name": "伊都きんぐ 甘王草莓銅鑼燒", "image": "images/BUY-21.jpg", "type": "甜點", "note": "甘王草莓慕斯。"}, {"name": "AMANBERRY草莓奶油餅乾", "image": "images/BUY-22.jpg", "type": "餅乾", "note": "貓舌餅與生巧克力奶油。"}, {"name": "YAMAYA軟管明太子醬", "image": "images/BUY-23.jpg", "type": "調味料", "note": "牙膏式軟管方便擠壓。"}, {"name": "福砂屋長崎蛋糕", "image": "images/BUY-24.jpg", "type": "蛋糕", "note": "底部有砂糖結晶顆粒。"}, {"name": "千鳥屋本家 捲心酥", "image": "images/BUY-25.jpg", "type": "餅乾", "note": "奧地利提洛邦傳統餅乾捲。"}
        ]);
        const foodList = ref([
            {"name": "Dacomecca", "note": "博多區有名麵包店，推薦：香腸、坦都里烤雞。", "address": "Dacomecca", "type": "麵包", "image": "images/EAT-1.jpg"}, {"name": "The Full Full Hakata", "note": "明太子法式麵包名店。", "address": "The Full Full Hakata", "type": "麵包", "image": "images/EAT-2.jpg"}, {"name": "MIGNON 博多店", "note": "位於JR中央口。經典小可頌。", "address": "MIGNON 博多店", "type": "甜點", "image": "images/EAT-3.jpg"}, {"name": "Cafe Mutsukado", "note": "主打生吐司，推薦蛋沙拉吐司。", "address": "Cafe Mutsukado", "type": "咖啡廳", "image": "images/EAT-4.jpg"}, {"name": "Pain Stock 天神店", "note": "主打天然酵母麵包，明太子法棍需櫃檯點。", "address": "Pain Stock 天神店", "type": "麵包", "image": "images/EAT-5.jpg"}, {"name": "Truffle Bakery", "note": "招牌：白松露鹽麵包。", "address": "mills by Truffle Bakery ソラリアステージ店", "type": "麵包", "image": "images/EAT-6.jpg"}, {"name": "博多一雙", "note": "豚骨泡沫系。", "address": "博多一雙", "type": "拉麵", "image": "images/EAT-7.jpg"}, {"name": "博多拉麵 ShinShin", "note": "濃郁卻清爽不膩。招牌：純情拉麵。", "address": "博多拉麵 ShinShin", "type": "拉麵", "image": "images/EAT-8.jpg"}, {"name": "麵屋兼虎", "note": "沾麵系霸主。", "address": "麵屋兼虎", "type": "拉麵", "image": "images/EAT-9.jpg"}, {"name": "大砲拉麵", "note": "久留米70年老店。", "address": "大砲ラーメン 天神今泉店", "type": "拉麵", "image": "images/EAT-10.jpg"}, {"name": "麵屋我ガ (Gaga)", "note": "湯頭較濃郁。", "address": "麺屋我ガ 天神店", "type": "拉麵", "image": "images/EAT-11.jpg"}, {"name": "茶壺烏龍麵", "note": "特殊茶壺裝盛。", "address": "博多あかちょこべ", "type": "烏龍麵", "image": "images/EAT-12.jpg"}, {"name": "麵屋 Isii", "note": "原創烏龍麵。", "address": "麵屋 Isii", "type": "烏龍麵", "image": "images/EAT-13.jpg"}, {"name": "FUK COFFEE", "note": "昭和風布丁口感紮實。", "address": "FUK COFFEE", "type": "咖啡廳", "image": "images/EAT-14.jpg"}, {"name": "藍瓶咖啡 天神店", "note": "九州第一間。", "address": "藍瓶咖啡 天神店", "type": "咖啡廳", "image": "images/EAT-15.jpg"}, {"name": "Coffee County", "note": "專注咖啡豆產地香氣。", "address": "Coffee County Fukuoka", "type": "咖啡廳", "image": "images/EAT-16.jpg"}, {"name": "Rec Coffee", "note": "推薦拿鐵系列&硬布丁。", "address": "Rec Coffee 福岡", "type": "咖啡廳", "image": "images/EAT-17.jpg"}, {"name": "かわ屋 (Kawaya)", "note": "招牌烤雞皮需6天燒烤熟成。", "address": "かわ屋 祇園店", "type": "居酒屋", "image": "images/EAT-18.jpg"}, {"name": "とりかわ粋恭", "note": "酥脆口感濃郁。", "address": "とりかわ粋恭", "type": "居酒屋", "image": "images/EAT-19.jpg"}, {"name": "博多雞皮大臣", "note": "分醬燒與鹽燒。", "address": "博多雞皮大臣", "type": "居酒屋", "image": "images/EAT-20.jpg"}, {"name": "寶雲亭", "note": "一口餃子。", "address": "寶雲亭", "type": "餃子", "image": "images/EAT-21.jpg"}, {"name": "海木豆皮壽司", "note": "豆皮壽司界的愛馬仕。", "address": "だしいなり 海木 福岡", "type": "壽司", "image": "images/EAT-22.jpg"}
        ]);
        const weatherData = ref([
            { "condition": "cloudy", "temp": "12/6", "chance": "30" }, { "condition": "sunny", "temp": "11/5", "chance": "10" }, { "condition": "rain", "temp": "10/4", "chance": "60" }, { "condition": "cloudy", "temp": "9/3", "chance": "20" }, { "condition": "sunny", "temp": "10/4", "chance": "10" }
        ]);
        const checkList = ref([{"text": "護照", "checked": false}, {"text": "Visit Japan Web", "checked": false}, {"text": "日幣/信用卡", "checked": false}, {"text": "行動電源", "checked": false}, {"text": "常備藥品", "checked": false}, {"text": "電子機票", "checked": false}, {"text": "eSIM/網卡", "checked": false}, {"text": "衣物", "checked": false}]);

        const expenses = ref([]);
        const exchangeRate = ref(0.215);
        const currencyInput = ref(10000);
        const currencyResult = ref(0);
        const memoText = ref('');
        const newChecklistItem = ref('');

        // Modals & Forms
        const showModal = ref(false);
        const showTitleModal = ref(false);
        const modalType = ref(''); // itinerary, list, expense, weather, title, info
        const infoFormType = ref('');
        const modalTitle = ref('');
        const isEdit = ref(false);
        const editIndex = ref(-1);
        const form = ref({});
        const weatherForm = ref({});
        const infoForm = ref({});

        const foodSearchQuery = ref(''), shoppingSearchQuery = ref('');
        const selectedFoodCategory = ref('全部'), selectedShoppingCategory = ref('全部');
        const foodCategories = ['全部', '拉麵', '麵包', '咖啡廳', '甜點', '居酒屋', '烏龍麵', '餃子', '壽司', '其他'];
        const shoppingCategories = ['全部', '伴手禮', '甜點', '餅乾', '蛋糕', '巧克力', '麵包', '調味料', '其他'];
        
        // Computed
        const selectedDateIndex = ref(0);
        const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
        const totalExpensesJPY = computed(() => expenses.value.reduce((sum, e) => sum + (Number(e.amount)||0), 0));
        const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * exchangeRate.value));
        const parsedLinks = computed(() => (memoText.value.match(/(https?:\/\/[^\s]+)/g) || []));
        
        const filteredFoodList = computed(() => filterList(foodList.value, foodSearchQuery.value, selectedFoodCategory.value));
        const filteredShoppingList = computed(() => filterList(shoppingList.value, shoppingSearchQuery.value, selectedShoppingCategory.value));
        const filterList = (list, query, cat) => list.map((item, i) => ({...item, originalIndex: i})).filter(item => {
            const matchQ = !query || item.name.toLowerCase().includes(query.toLowerCase()) || (item.note && item.note.includes(query));
            const matchC = cat === '全部' || item.type === cat;
            return matchQ && matchC;
        });

        // Helpers
        const calculateCurrency = () => currencyResult.value = Math.round((currencyInput.value || 0) * exchangeRate.value);
        const formatNumber = (n) => (n||0).toLocaleString();
        const getTabIcon = (t) => ({itinerary:'fa-solid fa-map-location-dot', food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', expenses:'fa-solid fa-coins'}[t]);
        const getTabLabel = (t) => ({itinerary:'行程', food:'美食', shopping:'購物', expenses:'花費'}[t]);
        const getCategoryIcon = (c) => ({sightseeing:'fa-solid fa-camera', food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', transport:'fa-solid fa-bus-simple', flight:'fa-solid fa-plane-departure', accommodation:'fa-solid fa-bed'}[c] || 'fa-solid fa-circle-info');
        const getCategoryColor = (c) => ({sightseeing:'bg-green-500', food:'bg-red-500', shopping:'bg-indigo-500', transport:'bg-orange-500', flight:'bg-blue-500', accommodation:'bg-purple-500'}[c] || 'bg-slate-400');
        const getTransportIcon = (t) => ({walk:'fa-solid fa-shoe-prints', public:'fa-solid fa-train-subway', bus:'fa-solid fa-bus-simple', flight:'fa-solid fa-plane', car:'fa-solid fa-car'}[t] || 'fa-solid fa-arrow-right-long');
        const getWeatherIcon = (c) => ({sunny:'fa-solid fa-sun', rain:'fa-solid fa-cloud-showers-heavy', cloudy:'fa-solid fa-cloud', snow:'fa-solid fa-snowflake'}[c]);
        const getWeatherDescription = (c) => ({sunny:'晴朗', rain:'降雨', cloudy:'多雲', snow:'降雪'}[c]);
        const getCategoryLabel = (c) => ({food:'飲食', shopping:'購物', transport:'交通', ticket:'門票', other:'其他'}[c]||'其他');

        // Actions
        const handleAddClick = () => {
            isEdit.value = false;
            if(currentTab.value === 'itinerary') {
                modalType.value = 'itinerary'; modalTitle.value = '新增行程';
                form.value = { name:'', category:'sightseeing', startTime:'', address:'', note:'', transportType:'public' };
            } else if(currentTab.value === 'food' || currentTab.value === 'shopping') {
                modalType.value = 'list'; modalTitle.value = currentTab.value==='food'?'新增美食':'新增購物';
                form.value = { name:'', type: currentTab.value==='food'?'拉麵':'伴手禮', address:'', note:'', image:'' };
            } else if(currentTab.value === 'expenses') {
                modalType.value = 'expense'; modalTitle.value = '記一筆';
                form.value = { name:'', amount:'', category:'food', date: dates.value[selectedDateIndex.value]?.date || '', payment:'cash' };
            }
            showModal.value = true;
        };

        const editItem = (item) => { isEdit.value = true; modalType.value = 'itinerary'; modalTitle.value = '編輯行程'; form.value = JSON.parse(JSON.stringify(item)); showModal.value = true; };
        const editFoodItem = (idx) => { isEdit.value = true; editIndex.value = idx; modalType.value = 'list'; modalTitle.value = '編輯美食'; form.value = {...foodList.value[idx]}; showModal.value = true; };
        const editShoppingItem = (idx) => { isEdit.value = true; editIndex.value = idx; modalType.value = 'list'; modalTitle.value = '編輯購物'; form.value = {...shoppingList.value[idx]}; showModal.value = true; };
        const openWeatherModal = () => {
            modalType.value = 'weather'; const w = weatherData.value[selectedDateIndex.value];
            const [h, l] = w.temp.split('/'); weatherForm.value = { condition: w.condition, chance: w.chance, high: h, low: l }; showModal.value = true;
        };
        const openInfoModal = (type) => { 
            modalType.value = 'info'; infoFormType.value = type; modalTitle.value = type==='flight'?'新增航班':'新增住宿';
            infoForm.value = { origin:'', dest:'', code:'', depTime:'', arrTime:'', name:'', address:'', date:'' };
            isEdit.value = false; showModal.value = true;
        };
        const editInfoItem = (type, item, idx) => {
             modalType.value = 'info'; infoFormType.value = type; modalTitle.value = type==='flight'?'編輯航班':'編輯住宿';
             infoForm.value = {...item}; isEdit.value = true; editIndex.value = idx; showModal.value = true;
        };

        const saveForm = () => {
             if(modalType.value === 'weather') {
                weatherData.value[selectedDateIndex.value] = { condition: weatherForm.value.condition, chance: weatherForm.value.chance, temp: `${weatherForm.value.high}/${weatherForm.value.low}` };
            } else if(modalType.value === 'itinerary') {
                const list = itineraryData.value[selectedDateIndex.value];
                if(isEdit.value) { const idx = list.findIndex(i=>i.id===form.value.id); if(idx!==-1) list[idx] = {...form.value}; }
                else { list.push({...form.value, id: Date.now()}); list.sort((a,b)=>(a.startTime||'').localeCompare(b.startTime||'')); }
            } else if(modalType.value === 'list') {
                const list = currentTab.value === 'food' ? foodList : shoppingList;
                if(isEdit.value) list.value[editIndex.value] = {...form.value}; else list.value.push({...form.value});
            } else if(modalType.value === 'expense') { expenses.value.push({...form.value}); }
            else if(modalType.value === 'info') {
                const list = infoFormType.value === 'flight' ? flightList : hotelList;
                if(isEdit.value) list.value[editIndex.value] = {...infoForm.value}; else list.value.push({...infoForm.value});
            }
            closeModal(); saveToStorage();
        };

        // Remove & Utils
        const removeItineraryItem = (id) => { const list=itineraryData.value[selectedDateIndex.value]; const idx=list.findIndex(i=>i.id===id); if(idx!==-1) list.splice(idx,1); saveToStorage(); };
        const removeFoodItem = (i) => { if(confirm('刪除?')) foodList.value.splice(i,1); saveToStorage(); };
        const removeShoppingItem = (i) => { if(confirm('刪除?')) shoppingList.value.splice(i,1); saveToStorage(); };
        const removeExpense = (i) => { expenses.value.splice(i,1); saveToStorage(); };
        const removeFlight = (i) => { flightList.value.splice(i,1); saveToStorage(); };
        const removeHotel = (i) => { hotelList.value.splice(i,1); saveToStorage(); };
        const removeChecklistItem = (i) => { checkList.value.splice(i,1); saveToStorage(); };
        const addChecklistItem = () => { if(newChecklistItem.value) { checkList.value.push({text:newChecklistItem.value, checked:false}); newChecklistItem.value=''; saveToStorage(); }};
        
        const moveItineraryUp = (id) => { const list=currentItinerary.value; const idx=list.findIndex(i=>i.id===id); if(idx>0){const item=list.splice(idx,1)[0]; list.splice(idx-1,0,item); saveToStorage();} };
        const moveItineraryDown = (id) => { const list=currentItinerary.value; const idx=list.findIndex(i=>i.id===id); if(idx<list.length-1){const item=list.splice(idx,1)[0]; list.splice(idx+1,0,item); saveToStorage();} };
        const addNewDay = () => { dates.value.push({date:'New', weekday:'-'}); itineraryData.value.push([]); weatherData.value.push({condition:'sunny', temp:'20/15', chance:0}); saveToStorage(); };
        const removeLastDay = () => { if(dates.value.length>1 && confirm('確定刪除最後一天?')) { dates.value.pop(); itineraryData.value.pop(); weatherData.value.pop(); if(selectedDateIndex.value>=dates.value.length) selectedDateIndex.value=dates.value.length-1; saveToStorage(); }};

        const openMap = (q) => { if(q) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank'); };
        const openMapDirections = (s, e) => { 
            const origin = s?.address || s?.name; const dest = e?.address || e?.name;
            if(origin && dest) window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=transit`, '_blank');
        };
        const copyText = (t) => { navigator.clipboard.writeText(t).then(()=>alert('已複製地址')).catch(()=>alert('複製失敗')); };
        const scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});
        const closeModal = () => { showModal.value = false; isEdit.value = false; editIndex.value = -1; };
        const formatNoteWithLinks = (text) => text ? text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline" onclick="event.stopPropagation()">連結</a>').replace(/\n/g, '<br>') : '';

        // Storage
        const saveToStorage = () => localStorage.setItem(STORAGE_KEY, JSON.stringify({
            tripSettings: tripSettings.value, dates: dates.value, itineraryData: itineraryData.value, weatherData: weatherData.value,
            foodList: foodList.value, shoppingList: shoppingList.value, expenses: expenses.value, checkList: checkList.value,
            hotelList: hotelList.value, flightList: flightList.value, memoText: memoText.value, exchangeRate: exchangeRate.value
        }));
        const loadFromStorage = () => {
            const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(d) {
                if(d.tripSettings) tripSettings.value=d.tripSettings; if(d.dates) dates.value=d.dates; if(d.itineraryData) itineraryData.value=d.itineraryData;
                if(d.weatherData) weatherData.value=d.weatherData; if(d.foodList) foodList.value=d.foodList; if(d.shoppingList) shoppingList.value=d.shoppingList;
                if(d.expenses) expenses.value=d.expenses; if(d.checkList) checkList.value=d.checkList; if(d.hotelList) hotelList.value=d.hotelList;
                if(d.flightList) flightList.value=d.flightList; if(d.memoText) memoText.value=d.memoText; if(d.exchangeRate) exchangeRate.value=d.exchangeRate;
            }
        };
        
        // Backup / Restore
        const backupData = () => {
            const data = localStorage.getItem(STORAGE_KEY);
            const blob = new Blob([data], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `fukuoka_trip_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        };
        const restoreData = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => { try { JSON.parse(ev.target.result); localStorage.setItem(STORAGE_KEY, ev.target.result); alert('還原成功！'); location.reload(); } catch(err){ alert('檔案錯誤'); } };
            reader.readAsText(file);
        };
        const resetData = () => { if(confirm('確定重置? 資料將清空!')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };

        onMounted(() => { loadFromStorage(); calculateCurrency(); window.addEventListener('scroll', () => showScrollTop.value = window.scrollY > 300); });
        watch([tripSettings, dates, itineraryData, foodList, shoppingList, expenses, checkList, hotelList, flightList, memoText, exchangeRate], saveToStorage, {deep:true});

        return {
            currentTab, dates, selectedDateIndex, currentItinerary, hotelList, flightList, shoppingList, filteredShoppingList, foodList, filteredFoodList,
            expenses, weatherData, checkList, tripSettings, memoText, exchangeRate, currencyInput, currencyResult, totalExpensesJPY, totalExpensesTWD,
            parsedLinks, foodSearchQuery, selectedFoodCategory, foodCategories, shoppingSearchQuery, selectedShoppingCategory, shoppingCategories,
            showModal, showTitleModal, modalType, modalTitle, form, weatherForm, infoForm, infoFormType, showScrollTop, newChecklistItem,
            handleAddClick, editItem, editFoodItem, editShoppingItem, editInfoItem, openWeatherModal, openInfoModal, saveForm, closeModal,
            removeItineraryItem, removeFoodItem, removeShoppingItem, removeExpense, removeFlight, removeHotel, removeChecklistItem, addChecklistItem,
            moveItineraryUp, moveItineraryDown, addNewDay, removeLastDay, openMap, openMapDirections, copyText, scrollToTop,
            backupData, restoreData, resetData, calculateCurrency, formatNumber, getTabIcon, getTabLabel, getCategoryIcon, getCategoryColor, getTransportIcon, getWeatherIcon, getWeatherDescription, getCategoryLabel, formatNoteWithLinks
        };
    }
}).mount('#app');
</script>
<style>.input-field { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem; font-size: 0.875rem; outline: none; transition: all 0.2s; margin-bottom: 0.5rem; } .input-field:focus { border-color: #01579B; box-shadow: 0 0 0 2px rgba(1, 87, 155, 0.1); }</style>
</body>
</html>